# èƒŒæ™¯è€—é›»å„ªåŒ– åŠŸèƒ½è¦æ ¼æ›¸

## 1. å•é¡Œæè¿°

### 1.1 ä½¿ç”¨è€…åé¥‹
- **ç¾è±¡**ï¼šiPhone é›»æ± ç®¡ç†é¡¯ç¤º app åœ¨èƒŒæ™¯æœƒ**ä¸åœå–šé†’**
- **å½±éŸ¿**ï¼šå°è‡´é¡å¤–çš„é›»æ± æ¶ˆè€—ï¼Œå½±éŸ¿ç”¨æˆ¶é«”é©—
- **åš´é‡æ€§**ï¼šğŸ”´ é«˜å„ªå…ˆç´šï¼ˆP0ï¼‰- å½±éŸ¿é›»æ± çºŒèˆªèˆ‡ App Store è©•åˆ†

### 1.2 æŠ€è¡“åˆ†æ
é€éç¨‹å¼ç¢¼å¯©æŸ¥ï¼Œç™¼ç¾ä»¥ä¸‹å¯èƒ½å°è‡´èƒŒæ™¯å–šé†’çš„æ ¹æœ¬åŸå› ï¼š

| å•é¡Œé¡å‹ | ä½ç½® | èªªæ˜ | åš´é‡æ€§ |
|---------|------|------|-------|
| **å»¶é²ä»»å‹™æœªå–æ¶ˆ** | `StatisticsViewModel.swift` L243<br>`ContentView.swift` L503 | `DispatchQueue.main.asyncAfter` åœ¨èƒŒæ™¯æ™‚ä»æœƒåŸ·è¡Œ | ğŸ”´ é«˜ |
| **Combine æŒçºŒè¨‚é–±** | `StatisticsViewModel.swift` L41, L55 | `$selectedYear` èˆ‡ `$selectedTimeRange` çš„ `.sink` è¨‚é–±æŒçºŒç›£è½ | ğŸŸ¡ ä¸­ |
| **ViewModel ç”Ÿå‘½é€±æœŸ** | `ContentView.swift` L22 | ä½¿ç”¨ `@ObservedObject` è€Œé `@StateObject`ï¼Œå¯èƒ½é‡è¤‡å»ºç«‹ | ğŸŸ¡ ä¸­ |
| **AppTheme Singleton** | `AppTheme.swift` L22 | `@Published var mode` è®ŠåŒ–æœƒå–šé†’æ‰€æœ‰è¨‚é–±è€… | ğŸŸ¡ ä¸­ |
| **ç¶²è·¯è«‹æ±‚æœªå–æ¶ˆ** | `ChargedLogService.swift` | URLSession è«‹æ±‚æ²’æœ‰å–æ¶ˆæ©Ÿåˆ¶ | ğŸŸ¢ ä½ |
| **ç„¡èƒŒæ™¯æ¸…ç†æ©Ÿåˆ¶** | å…¨åŸŸ | é€²å…¥èƒŒæ™¯æ™‚æ²’æœ‰æš«åœæˆ–æ¸…ç†è³‡æº | ğŸ”´ é«˜ |

---

## 2. æ ¹æœ¬åŸå› æ·±å…¥åˆ†æ

### 2.1 å»¶é²ä»»å‹™ï¼ˆDispatchQueue.main.asyncAfterï¼‰

#### å•é¡Œç¨‹å¼ç¢¼
```swift
// StatisticsViewModel.swift L243
private func clearTipAfterDelay() {
    DispatchQueue.main.asyncAfter(deadline: .now() + 3.0) {
        self.filterTip = ""
    }
}

// ContentView.swift L503
DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
    onSelect()
    dismiss()
}
```

#### ç‚ºä½•å°è‡´èƒŒæ™¯å–šé†’ï¼Ÿ
- `asyncAfter` æœƒåœ¨æŒ‡å®šæ™‚é–“å¾Œå°‡ä»»å‹™åŠ å…¥ä¸»åŸ·è¡Œç·’
- **å³ä½¿ app åœ¨èƒŒæ™¯ï¼Œé€™å€‹ä»»å‹™ä»æœƒåŸ·è¡Œ**
- åŸ·è¡Œæ™‚æœƒå–šé†’ app ä¾†æ›´æ–° UI
- å¦‚æœç”¨æˆ¶é »ç¹åˆ‡æ›ç¯©é¸æ¢ä»¶ï¼Œæœƒç´¯ç©å¤šå€‹å»¶é²ä»»å‹™

#### å¯¦æ¸¬æƒ…å¢ƒ
```
ç”¨æˆ¶æ“ä½œæ™‚é–“è»¸ï¼š
14:00:00 - é–‹å•Ÿ appï¼Œåˆ‡æ›å¹´ä»½ï¼ˆè§¸ç™¼ clearTipAfterDelayï¼‰
14:00:01 - æŒ‰ Home éµï¼Œapp é€²å…¥èƒŒæ™¯
14:00:03 - âŒ App è¢«å–šé†’åŸ·è¡Œ self.filterTip = ""
14:00:05 - å†æ¬¡åˆ‡æ›å¹´ä»½ï¼ˆè§¸ç™¼æ–°çš„ clearTipAfterDelayï¼‰
14:00:06 - é€²å…¥èƒŒæ™¯
14:00:09 - âŒ App å†æ¬¡è¢«å–šé†’
```

---

### 2.2 Combine è¨‚é–±æŒçºŒç›£è½

#### å•é¡Œç¨‹å¼ç¢¼
```swift
// StatisticsViewModel.swift init()
$selectedYear
    .sink { [weak self] year in
        // ...é‚è¼¯...
        self.filterTip = "å·²è‡ªå‹•åˆ‡æ›åˆ°ã€Œå…¨éƒ¨æ™‚é–“ç¯„åœã€..."
        self.clearTipAfterDelay() // â† è§¸ç™¼å»¶é²ä»»å‹™
    }
    .store(in: &cancellables)

$selectedTimeRange
    .sink { [weak self] timeRange in
        // ...é‚è¼¯...
        self.filterTip = "å·²è‡ªå‹•åˆ‡æ›åˆ°ã€Œå…¨éƒ¨å¹´ä»½ã€..."
        self.clearTipAfterDelay() // â† è§¸ç™¼å»¶é²ä»»å‹™
    }
    .store(in: &cancellables)
```

#### ç‚ºä½•å°è‡´å•é¡Œï¼Ÿ
- `.sink` è¨‚é–±æœƒ**æŒçºŒç›£è½** `@Published` å±¬æ€§è®ŠåŒ–
- å³ä½¿åœ¨èƒŒæ™¯ï¼Œåªè¦å±¬æ€§è®ŠåŒ–å°±æœƒè§¸ç™¼å›èª¿
- å›èª¿ä¸­çš„ `clearTipAfterDelay()` åˆè§¸ç™¼å»¶é²ä»»å‹™
- **æ²’æœ‰åœ¨èƒŒæ™¯æ™‚æš«åœè¨‚é–±çš„æ©Ÿåˆ¶**

---

### 2.3 ViewModel ç”Ÿå‘½é€±æœŸå•é¡Œ

#### å•é¡Œç¨‹å¼ç¢¼
```swift
// ContentView.swift L22
@ObservedObject private var viewModel = ChargedLogViewModel()
```

#### æ­£ç¢ºåšæ³•
```swift
@StateObject private var viewModel = ChargedLogViewModel()
```

#### å·®ç•°èªªæ˜
| é¡å‹ | ç”Ÿå‘½é€±æœŸ | é‡å»ºè¡Œç‚º |
|------|---------|---------|
| `@ObservedObject` | ç”±çˆ¶ View ç®¡ç† | **View é‡ç¹ªæ™‚å¯èƒ½é‡å»ºå¯¦ä¾‹** |
| `@StateObject` | ç”± SwiftUI ç®¡ç† | View é‡ç¹ªæ™‚**ä¿æŒåŒä¸€å¯¦ä¾‹** |

#### ç‚ºä½•å½±éŸ¿èƒŒæ™¯è€—é›»ï¼Ÿ
- `@ObservedObject` å¯èƒ½åœ¨ View åˆ·æ–°æ™‚é‡å»º ViewModel
- é‡å»ºæœƒé‡æ–°åŸ·è¡Œ `init()`ï¼Œé‡æ–°è¨­å®šè¨‚é–±
- **ç´¯ç©è¨‚é–±æœªæ¸…ç†ï¼Œå°è‡´è¨˜æ†¶é«”æ´©æ¼èˆ‡è³‡æºæµªè²»**

---

### 2.4 AppTheme Singleton èˆ‡ UserDefaults

#### å•é¡Œç¨‹å¼ç¢¼
```swift
// AppTheme.swift
class AppTheme: ObservableObject {
    static let shared = AppTheme()
    
    @Published var mode: AppThemeMode {
        didSet {
            UserDefaults.standard.set(mode.rawValue, forKey: "appThemeMode")
        }
    }
}
```

#### æ½›åœ¨å•é¡Œ
1. **UserDefaults å¯«å…¥è§¸ç™¼ç£ç¢Ÿ I/O**
   - `didSet` æ¯æ¬¡éƒ½æœƒå¯«å…¥ç£ç¢Ÿ
   - iOS å¯èƒ½åœ¨èƒŒæ™¯æ™‚åŒæ­¥ UserDefaultsï¼Œå–šé†’ app
   
2. **Singleton æŒçºŒå­˜åœ¨**
   - å³ä½¿åœ¨èƒŒæ™¯ï¼Œsingleton ä»åœ¨è¨˜æ†¶é«”ä¸­
   - `@Published` è®ŠåŒ–æœƒé€šçŸ¥æ‰€æœ‰ View

---

### 2.5 ç¶²è·¯è«‹æ±‚æœªå–æ¶ˆ

#### å•é¡Œç¨‹å¼ç¢¼
```swift
// ChargedLogService.swift
URLSession.shared.dataTask(with: url) { data, response, error in
    // ...
}.resume()
```

#### ç‚ºä½•æ˜¯å•é¡Œï¼Ÿ
- ä½¿ç”¨ `URLSession.shared` æ²’æœ‰å–æ¶ˆæ©Ÿåˆ¶
- é€²å…¥èƒŒæ™¯æ™‚ï¼Œé€²è¡Œä¸­çš„è«‹æ±‚å¯èƒ½ç¹¼çºŒåŸ·è¡Œ
- å›èª¿è§¸ç™¼æ™‚æœƒå–šé†’ app æ›´æ–° UI

---

## 3. æ”¹å–„æ–¹æ¡ˆ

### 3.1 å„ªå…ˆç´šå®šç¾©

| å„ªå…ˆç´š | èªªæ˜ | å¯¦ä½œé †åº |
|--------|------|---------|
| P0 | **é—œéµä¿®å¾©**ï¼Œç›´æ¥å°è‡´èƒŒæ™¯å–šé†’ | ç«‹å³å¯¦ä½œ |
| P1 | **é‡è¦å„ªåŒ–**ï¼Œå¯èƒ½é–“æ¥å½±éŸ¿ | çŸ­æœŸå¯¦ä½œ |
| P2 | **æœ€ä½³å¯¦è¸**ï¼Œæå‡æ•´é«”å“è³ª | ä¸­é•·æœŸå¯¦ä½œ |

---

### 3.2 P0 æ”¹å–„æ–¹æ¡ˆï¼ˆå¿…é ˆç«‹å³å¯¦ä½œï¼‰

#### æ–¹æ¡ˆ P0-1ï¼šå–æ¶ˆå»¶é²ä»»å‹™æ©Ÿåˆ¶

**ç›®æ¨™**ï¼šé€²å…¥èƒŒæ™¯æ™‚å–æ¶ˆæ‰€æœ‰å»¶é²ä»»å‹™

**StatisticsViewModel.swift ä¿®æ”¹ï¼š**
```swift
class StatisticsViewModel: ObservableObject {
    // ...existing code...
    
    // æ–°å¢ï¼šå»¶é²ä»»å‹™ç®¡ç†
    private var clearTipWorkItem: DispatchWorkItem?
    
    // ä¿®æ”¹ï¼šå¯å–æ¶ˆçš„å»¶é²æ–¹æ³•
    private func clearTipAfterDelay() {
        // å…ˆå–æ¶ˆä¹‹å‰çš„ä»»å‹™
        clearTipWorkItem?.cancel()
        
        // å»ºç«‹æ–°çš„å¯å–æ¶ˆä»»å‹™
        let workItem = DispatchWorkItem { [weak self] in
            self?.filterTip = ""
        }
        clearTipWorkItem = workItem
        
        DispatchQueue.main.asyncAfter(deadline: .now() + 3.0, execute: workItem)
    }
    
    // æ–°å¢ï¼šå–æ¶ˆæ‰€æœ‰å»¶é²ä»»å‹™
    func cancelPendingTasks() {
        clearTipWorkItem?.cancel()
        clearTipWorkItem = nil
    }
    
    // æ–°å¢ï¼šdeinit ç¢ºä¿æ¸…ç†
    deinit {
        cancelPendingTasks()
        cancellables.removeAll()
        print("âœ… StatisticsViewModel deinitialized")
    }
}
```

**ContentView.swift èƒŒæ™¯ç®¡ç†ï¼š**
```swift
.onChange(of: scenePhase) { newPhase in
    switch newPhase {
    case .active:
        viewModel.refreshIfNeeded()
        statisticsViewModel.loadStatistics()
    case .background, .inactive:
        // âœ… é€²å…¥èƒŒæ™¯æ™‚å–æ¶ˆå»¶é²ä»»å‹™
        statisticsViewModel.cancelPendingTasks()
        viewModel.cancelPendingRequests()
        print("ğŸŒ™ App entered background, tasks cancelled")
    @unknown default:
        break
    }
}
```

---

#### æ–¹æ¡ˆ P0-2ï¼šDatePicker Sheet å»¶é²ä»»å‹™å„ªåŒ–

**å•é¡Œ**ï¼šContentView.swift L503 çš„ `asyncAfter(deadline: .now() + 0.1)` æ˜¯ç‚ºäº†ç­‰å¾…å‹•ç•«å®Œæˆ

**æ”¹å–„æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `.transaction` æˆ–ç§»é™¤å»¶é²

```swift
// ContentView.swift - DatePickerSheet ä¿®æ”¹
struct DatePickerSheet: View {
    let title: String
    @Binding var date: Date
    var range: ClosedRange<Date>?
    var onSelect: () -> Void

    @Environment(\.dismiss) private var dismiss

    var body: some View {
        VStack {
            DatePicker(title, selection: Binding(
                get: { date },
                set: { newValue in
                    date = newValue
                    // âœ… æ–¹æ¡ˆ Aï¼šç§»é™¤å»¶é²ï¼Œç›´æ¥åŸ·è¡Œ
                    onSelect()
                    dismiss()
                    
                    /* âŒ åŸæœ¬çš„å»¶é²æ–¹å¼
                    DispatchQueue.main.asyncAfter(deadline: .now() + 0.1) {
                        onSelect()
                        dismiss()
                    }
                    */
                }
            ), in: range ?? Date.distantPast...Date.distantFuture, displayedComponents: [.date])
                .datePickerStyle(.graphical)
                .labelsHidden()
                .padding()
        }
        .presentationDetents([.medium])
    }
}
```

---

#### æ–¹æ¡ˆ P0-3ï¼šä¿®æ­£ ViewModel ç”Ÿå‘½é€±æœŸ

**ContentView.swift ä¿®æ”¹ï¼š**
```swift
// âŒ éŒ¯èª¤åšæ³•
@ObservedObject private var viewModel = ChargedLogViewModel()

// âœ… æ­£ç¢ºåšæ³•
@StateObject private var viewModel = ChargedLogViewModel()
```

**å½±éŸ¿ç¯„åœï¼š**
- [ContentView.swift](ContentView.swift#L22)ï¼šä¿®æ”¹ `viewModel`
- ç¢ºèªå…¶ä»–ä½¿ç”¨ `@ObservedObject` çš„åœ°æ–¹æ˜¯å¦æ‡‰æ”¹ç‚º `@StateObject`

---

#### æ–¹æ¡ˆ P0-4ï¼šç¶²è·¯è«‹æ±‚å–æ¶ˆæ©Ÿåˆ¶

**ChargedLogViewModel.swift æ–°å¢ï¼š**
```swift
class ChargedLogViewModel: ObservableObject {
    // ...existing code...
    
    // æ–°å¢ï¼šç•¶å‰é€²è¡Œä¸­çš„è«‹æ±‚
    private var currentTask: URLSessionDataTask?
    
    func loadLogs() {
        isLoading = true
        errorMessage = nil
        
        // âœ… å…ˆå–æ¶ˆä¹‹å‰çš„è«‹æ±‚
        currentTask?.cancel()
        
        // å–å¾— task ä¸¦å„²å­˜
        currentTask = ChargedLogService.shared.fetchChargedLogs { [weak self] result in
            DispatchQueue.main.async {
                self?.isLoading = false
                self?.currentTask = nil // è«‹æ±‚å®Œæˆï¼Œæ¸…ç©º
                
                switch result {
                case .success(let logs):
                    self?.logs = logs
                case .failure(let error):
                    // âœ… å€åˆ†å–æ¶ˆèˆ‡çœŸå¯¦éŒ¯èª¤
                    if (error as? URLError)?.code != .cancelled {
                        self?.errorMessage = error.localizedDescription
                    }
                }
            }
        }
    }
    
    // æ–°å¢ï¼šå–æ¶ˆè«‹æ±‚
    func cancelPendingRequests() {
        currentTask?.cancel()
        currentTask = nil
        isLoading = false
    }
    
    // æ–°å¢ï¼šdeinit ç¢ºä¿æ¸…ç†
    deinit {
        cancelPendingRequests()
        print("âœ… ChargedLogViewModel deinitialized")
    }
}
```

**ChargedLogService.swift ä¿®æ”¹ï¼š**
```swift
// âœ… ä¿®æ”¹ç‚ºå›å‚³ URLSessionDataTask
func fetchChargedLogs(completion: @escaping (Result<[ChargedLogEntry], Error>) -> Void) -> URLSessionDataTask? {
    guard let url = URL(string: chargedLogEndpoint) else {
        completion(.failure(NSError(domain: "Invalid URL", code: -1)))
        return nil
    }

    print("ChargedLog API URL: \(url.absoluteString)")

    let task = URLSession.shared.dataTask(with: url) { data, response, error in
        if let error = error {
            completion(.failure(error))
            return
        }
        guard let data = data else {
            completion(.failure(NSError(domain: "No data", code: -2)))
            return
        }
        do {
            let apiResponse = try JSONDecoder().decode(APIResponse.self, from: data)
            let entries = self.parseRows(apiResponse.values)
            completion(.success(entries))
        } catch {
            completion(.failure(error))
        }
    }
    task.resume()
    return task // âœ… å›å‚³ task ä¾›å–æ¶ˆä½¿ç”¨
}
```

---

### 3.3 P1 æ”¹å–„æ–¹æ¡ˆï¼ˆé‡è¦å„ªåŒ–ï¼‰

#### æ–¹æ¡ˆ P1-1ï¼šURLSession é…ç½®å„ªåŒ–

**ChargedLogService.swift æ–°å¢ï¼š**
```swift
class ChargedLogService {
    static let shared = ChargedLogService()

    // ...existing code...
    
    // âœ… æ–°å¢ï¼šè‡ªè¨‚ URLSession é…ç½®
    private lazy var urlSession: URLSession = {
        let config = URLSessionConfiguration.default
        config.timeoutIntervalForRequest = 30  // è«‹æ±‚è¶…æ™‚ 30 ç§’
        config.timeoutIntervalForResource = 60 // è³‡æºè¶…æ™‚ 60 ç§’
        config.waitsForConnectivity = true
        config.requestCachePolicy = .returnCacheDataElseLoad
        
        // âœ… èƒŒæ™¯ç­–ç•¥
        config.shouldUseExtendedBackgroundIdleMode = false
        
        return URLSession(configuration: config)
    }()
    
    func fetchChargedLogs(completion: @escaping (Result<[ChargedLogEntry], Error>) -> Void) -> URLSessionDataTask? {
        guard let url = URL(string: chargedLogEndpoint) else {
            completion(.failure(NSError(domain: "Invalid URL", code: -1)))
            return nil
        }

        print("ChargedLog API URL: \(url.absoluteString)")

        // âœ… ä½¿ç”¨è‡ªè¨‚ session è€Œé URLSession.shared
        let task = urlSession.dataTask(with: url) { data, response, error in
            // ...existing code...
        }
        task.resume()
        return task
    }
}
```

---

#### æ–¹æ¡ˆ P1-2ï¼šCombine è¨‚é–±ç”Ÿå‘½é€±æœŸç®¡ç†

**StatisticsViewModel.swift ä¿®æ”¹ï¼š**
```swift
class StatisticsViewModel: ObservableObject {
    // ...existing code...
    
    private var cancellables = Set<AnyCancellable>()
    
    // âœ… æ–°å¢ï¼šæš«åœ/æ¢å¾©è¨‚é–±æ©Ÿåˆ¶
    private var isSubscriptionActive = true
    
    init() {
        // ...existing code...
        
        $selectedYear
            .sink { [weak self] year in
                guard let self = self, self.isSubscriptionActive else { return }
                // ...existing logic...
            }
            .store(in: &cancellables)
        
        $selectedTimeRange
            .sink { [weak self] timeRange in
                guard let self = self, self.isSubscriptionActive else { return }
                // ...existing logic...
            }
            .store(in: &cancellables)
    }
    
    // âœ… æ–°å¢ï¼šæš«åœè¨‚é–±ï¼ˆé€²å…¥èƒŒæ™¯æ™‚å‘¼å«ï¼‰
    func pauseSubscriptions() {
        isSubscriptionActive = false
        cancelPendingTasks()
    }
    
    // âœ… æ–°å¢ï¼šæ¢å¾©è¨‚é–±ï¼ˆé€²å…¥å‰æ™¯æ™‚å‘¼å«ï¼‰
    func resumeSubscriptions() {
        isSubscriptionActive = true
    }
    
    deinit {
        cancelPendingTasks()
        cancellables.removeAll()
        print("âœ… StatisticsViewModel deinitialized")
    }
}
```

**ContentView.swift æ•´åˆï¼š**
```swift
.onChange(of: scenePhase) { newPhase in
    switch newPhase {
    case .active:
        // âœ… æ¢å¾©è¨‚é–±
        statisticsViewModel.resumeSubscriptions()
        viewModel.refreshIfNeeded()
    case .background, .inactive:
        // âœ… æš«åœè¨‚é–±èˆ‡å–æ¶ˆä»»å‹™
        statisticsViewModel.pauseSubscriptions()
        statisticsViewModel.cancelPendingTasks()
        viewModel.cancelPendingRequests()
        print("ğŸŒ™ App entered background")
    @unknown default:
        break
    }
}
```

---

#### æ–¹æ¡ˆ P1-3ï¼šæ™ºæ…§åˆ·æ–°ç­–ç•¥

**ChargedLogViewModel.swift ä¿®æ”¹ï¼š**
```swift
class ChargedLogViewModel: ObservableObject {
    // ...existing code...
    
    // âœ… èª¿æ•´ï¼šæœ€å°åˆ·æ–°é–“éš”å¾ 10 åˆ†é˜æ”¹ç‚º 30 åˆ†é˜
    let minRefreshInterval: TimeInterval = 1800 // 30 åˆ†é˜ï¼ˆåŸæœ¬ 600 ç§’ï¼‰
    
    /// é€²å…¥å‰æ™¯æ™‚è‡ªå‹•æ›´æ–°ï¼ˆæœ‰æœ€å°é–“éš”é™åˆ¶ï¼‰
    func refreshIfNeeded(minInterval: TimeInterval? = nil) {
        let now = Date()
        let interval = minInterval ?? minRefreshInterval
        
        if let last = lastActiveDate {
            let elapsed = now.timeIntervalSince(last)
            if elapsed < interval {
                // âœ… æœªè¶…éæœ€å°é–“éš”ï¼Œä¸åˆ·æ–°
                print("â¸ï¸ Refresh skipped (elapsed: \(Int(elapsed))s < \(Int(interval))s)")
                return
            }
        }
        
        lastActiveDate = now
        self.endDate = now
        print("ğŸ”„ Refreshing data (last refresh: \(lastActiveDate?.description ?? "never"))")
        loadLogs()
    }
}
```

---

### 3.4 P2 æ”¹å–„æ–¹æ¡ˆï¼ˆæœ€ä½³å¯¦è¸ï¼‰

#### æ–¹æ¡ˆ P2-1ï¼šAppTheme UserDefaults å„ªåŒ–

**AppTheme.swift ä¿®æ”¹ï¼š**
```swift
class AppTheme: ObservableObject {
    static let shared = AppTheme()
    
    @Published var mode: AppThemeMode {
        didSet {
            // âœ… å»¶é²å¯«å…¥ï¼Œé¿å…é »ç¹ç£ç¢Ÿ I/O
            saveWorkItem?.cancel()
            let workItem = DispatchWorkItem { [weak self] in
                guard let self = self else { return }
                UserDefaults.standard.set(self.mode.rawValue, forKey: "appThemeMode")
                print("ğŸ’¾ Theme saved: \(self.mode.rawValue)")
            }
            saveWorkItem = workItem
            DispatchQueue.main.asyncAfter(deadline: .now() + 1.0, execute: workItem)
        }
    }
    
    // âœ… æ–°å¢ï¼šå»¶é²å„²å­˜ä»»å‹™
    private var saveWorkItem: DispatchWorkItem?
    
    init() {
        let savedMode = UserDefaults.standard.string(forKey: "appThemeMode") ?? "dark"
        self.mode = AppThemeMode(rawValue: savedMode) ?? .dark
    }
    
    // âœ… æ–°å¢ï¼šç«‹å³å„²å­˜ï¼ˆé€²å…¥èƒŒæ™¯æ™‚å‘¼å«ï¼‰
    func saveImmediately() {
        saveWorkItem?.cancel()
        saveWorkItem = nil
        UserDefaults.standard.set(mode.rawValue, forKey: "appThemeMode")
        print("ğŸ’¾ Theme saved immediately: \(mode.rawValue)")
    }
    
    // ...existing code...
}
```

**ContentView.swift æ•´åˆï¼š**
```swift
.onChange(of: scenePhase) { newPhase in
    switch newPhase {
    case .active:
        // ...
    case .background:
        // âœ… é€²å…¥èƒŒæ™¯æ™‚ç«‹å³å„²å­˜è¨­å®š
        theme.saveImmediately()
        // ...
    case .inactive:
        break
    @unknown default:
        break
    }
}
```

---

#### æ–¹æ¡ˆ P2-2ï¼šç¶²è·¯ç‹€æ…‹æª¢æ¸¬

**æ–°å¢æª”æ¡ˆï¼šNetworkMonitor.swift**
```swift
import Foundation
import Network

class NetworkMonitor: ObservableObject {
    static let shared = NetworkMonitor()
    
    private let monitor = NWPathMonitor()
    private let queue = DispatchQueue.global(qos: .background)
    
    @Published var isConnected = true
    @Published var connectionType: NWInterface.InterfaceType?
    
    init() {
        monitor.pathUpdateHandler = { [weak self] path in
            DispatchQueue.main.async {
                self?.isConnected = path.status == .satisfied
                self?.connectionType = path.availableInterfaces.first?.type
            }
        }
        monitor.start(queue: queue)
    }
    
    deinit {
        monitor.cancel()
    }
}
```

**ChargedLogViewModel.swift æ•´åˆï¼š**
```swift
class ChargedLogViewModel: ObservableObject {
    // ...existing code...
    
    private let networkMonitor = NetworkMonitor.shared
    
    func loadLogs() {
        // âœ… æª¢æŸ¥ç¶²è·¯ç‹€æ…‹
        guard networkMonitor.isConnected else {
            errorMessage = "ç„¡ç¶²è·¯é€£ç·šï¼Œè«‹æª¢æŸ¥ç¶²è·¯è¨­å®š"
            return
        }
        
        // ...existing code...
    }
}
```

---

#### æ–¹æ¡ˆ P2-3ï¼šDebug æ—¥èªŒèˆ‡ç›£æ§

**æ–°å¢ï¼šBackgroundActivityLogger.swift**
```swift
import Foundation

class BackgroundActivityLogger {
    static let shared = BackgroundActivityLogger()
    
    private init() {}
    
    #if DEBUG
    func log(_ message: String, file: String = #file, function: String = #function, line: Int = #line) {
        let fileName = (file as NSString).lastPathComponent
        let timestamp = DateFormatter.localizedString(from: Date(), dateStyle: .none, timeStyle: .medium)
        print("ğŸ” [\(timestamp)] [\(fileName):\(line)] \(message)")
    }
    #else
    func log(_ message: String, file: String = #file, function: String = #function, line: Int = #line) {
        // Release æ¨¡å¼ä¸è¼¸å‡º
    }
    #endif
}
```

**ä½¿ç”¨ç¯„ä¾‹ï¼š**
```swift
// åœ¨å„ ViewModel ä¸­
BackgroundActivityLogger.shared.log("âœ… ViewModel initialized")
BackgroundActivityLogger.shared.log("ğŸŒ™ Entering background, cancelling tasks")
BackgroundActivityLogger.shared.log("â˜€ï¸ Entering foreground, resuming")
```

---

## 4. å¯¦ä½œè¨ˆç•«

### 4.1 å¯¦ä½œå„ªå…ˆåº

| éšæ®µ | å„ªå…ˆç´š | é …ç›® | é ä¼°å·¥æ™‚ | é æœŸæ•ˆæœ |
|------|--------|------|---------|---------|
| **Phase 1** | P0 | å–æ¶ˆå»¶é²ä»»å‹™æ©Ÿåˆ¶ | 1h | ğŸ”´ æ¶ˆé™¤ä¸»è¦å–šé†’æº |
| **Phase 1** | P0 | DatePicker å»¶é²ç§»é™¤ | 0.5h | ğŸ”´ æ¶ˆé™¤æ¬¡è¦å–šé†’æº |
| **Phase 1** | P0 | ä¿®æ­£ ViewModel ç”Ÿå‘½é€±æœŸ | 0.5h | ğŸŸ¡ æ¸›å°‘è¨˜æ†¶é«”æ´©æ¼ |
| **Phase 1** | P0 | ç¶²è·¯è«‹æ±‚å–æ¶ˆæ©Ÿåˆ¶ | 1.5h | ğŸŸ¡ æ¸›å°‘èƒŒæ™¯ç¶²è·¯æ´»å‹• |
| **Phase 2** | P1 | URLSession é…ç½®å„ªåŒ– | 1h | ğŸŸ¢ æå‡ç¶²è·¯æ•ˆèƒ½ |
| **Phase 2** | P1 | Combine è¨‚é–±ç®¡ç† | 1h | ğŸŸ¢ æ¸›å°‘èƒŒæ™¯ç›£è½ |
| **Phase 2** | P1 | æ™ºæ…§åˆ·æ–°ç­–ç•¥ | 0.5h | ğŸŸ¢ æ¸›å°‘ä¸å¿…è¦åˆ·æ–° |
| **Phase 3** | P2 | AppTheme å„ªåŒ– | 0.5h | ğŸŸ¢ æ¸›å°‘ç£ç¢Ÿ I/O |
| **Phase 3** | P2 | ç¶²è·¯ç‹€æ…‹æª¢æ¸¬ | 1h | ğŸŸ¢ æ™ºæ…§ç¶²è·¯ç®¡ç† |
| **Phase 3** | P2 | Debug æ—¥èªŒ | 0.5h | ğŸŸ¢ ä¾¿æ–¼å•é¡Œè¿½è¹¤ |

**ç¸½é ä¼°å·¥æ™‚ï¼šç´„ 8 å°æ™‚**

---

### 4.2 æ¸¬è©¦æ–¹æ³•

#### æ¸¬è©¦ä¸€ï¼šèƒŒæ™¯å–šé†’é »ç‡æ¸¬è©¦

**æ­¥é©Ÿï¼š**
1. é–‹å•Ÿ appï¼Œæ­£å¸¸ä½¿ç”¨ 3 åˆ†é˜
2. æŒ‰ Home éµï¼Œè®“ app é€²å…¥èƒŒæ™¯
3. ç­‰å¾… 30 åˆ†é˜ï¼Œä¸æ“ä½œå…¶ä»– app
4. å‰å¾€ã€Œè¨­å®š > é›»æ±  > é¡¯ç¤ºæ´»å‹•ã€
5. æª¢æŸ¥è©² app çš„ã€ŒèƒŒæ™¯æ´»å‹•ã€æ™‚é–“

**é æœŸçµæœï¼š**
- âœ… **æ”¹å–„å‰**ï¼šé¡¯ç¤ºå¤šæ¬¡ 1-5 ç§’çš„å–šé†’
- âœ… **æ”¹å–„å¾Œ**ï¼šèƒŒæ™¯æ´»å‹•æ™‚é–“æ¥è¿‘ 0

---

#### æ¸¬è©¦äºŒï¼šå»¶é²ä»»å‹™å–æ¶ˆæ¸¬è©¦

**æ­¥é©Ÿï¼š**
1. é–‹å•Ÿ appï¼Œé€²å…¥çµ±è¨ˆé é¢
2. å¿«é€Ÿåˆ‡æ›å¹´ä»½ 5 æ¬¡ï¼ˆè§¸ç™¼ `clearTipAfterDelay` 5 æ¬¡ï¼‰
3. ç«‹å³æŒ‰ Home éµé€²å…¥èƒŒæ™¯
4. è§€å¯Ÿ Xcode Console è¼¸å‡º

**é æœŸçµæœï¼š**
- âœ… çœ‹åˆ°æ—¥èªŒï¼š`ğŸŒ™ App entered background, tasks cancelled`
- âœ… **ä¸æœƒ**çœ‹åˆ°å»¶é²ä»»å‹™çš„åŸ·è¡Œæ—¥èªŒï¼ˆå¦‚ `filterTip = ""`ï¼‰

---

#### æ¸¬è©¦ä¸‰ï¼šViewModel ç”Ÿå‘½é€±æœŸæ¸¬è©¦

**æ­¥é©Ÿï¼š**
1. åœ¨å„ ViewModel çš„ `deinit` åŠ å…¥ `print("âœ… XXXViewModel deinitialized")`
2. é–‹å•Ÿ appï¼Œæ­£å¸¸ä½¿ç”¨
3. é—œé–‰ appï¼ˆé›™æ“Š Home ä¸Šæ»‘æ¸…é™¤ï¼‰
4. è§€å¯Ÿ Xcode Console

**é æœŸçµæœï¼š**
- âœ… çœ‹åˆ°æ‰€æœ‰ ViewModel çš„ deinit æ—¥èªŒ
- âœ… ç¢ºèªæ²’æœ‰è¨˜æ†¶é«”æ´©æ¼

---

#### æ¸¬è©¦å››ï¼šç¶²è·¯è«‹æ±‚å–æ¶ˆæ¸¬è©¦

**æ­¥é©Ÿï¼š**
1. é–‹å•Ÿ app
2. ä¸‹æ‹‰è§¸ç™¼åˆ·æ–°ï¼ˆé–‹å§‹ç¶²è·¯è«‹æ±‚ï¼‰
3. **ç«‹å³**æŒ‰ Home éµé€²å…¥èƒŒæ™¯
4. è§€å¯Ÿ Xcode Console

**é æœŸçµæœï¼š**
- âœ… çœ‹åˆ°æ—¥èªŒï¼š`ğŸŒ™ App entered background`
- âœ… çœ‹åˆ°æ—¥èªŒï¼š`âœ… URLSessionTask cancelled`
- âœ… **ä¸æœƒ**çœ‹åˆ° API å®Œæˆçš„å›èª¿æ—¥èªŒ

---

#### æ¸¬è©¦äº”ï¼šInstruments Energy Log æ¸¬è©¦

**æ­¥é©Ÿï¼š**
1. åœ¨ Xcode ä¸­é¸æ“‡ `Product > Profile`
2. é¸æ“‡ `Energy Log` å·¥å…·
3. åŸ·è¡Œ app ä¸¦æ“ä½œ 3 åˆ†é˜
4. è®“ app é€²å…¥èƒŒæ™¯ 10 åˆ†é˜
5. åœæ­¢è¨˜éŒ„ï¼Œåˆ†æçµæœ

**æª¢æŸ¥é …ç›®ï¼š**
- âœ… **CPU Wakeups**ï¼šèƒŒæ™¯æ™‚æ‡‰æ¥è¿‘ 0
- âœ… **Network Activity**ï¼šèƒŒæ™¯æ™‚æ‡‰ç‚º 0
- âœ… **Energy Impact**ï¼šèƒŒæ™¯æ™‚æ‡‰ç‚ºã€Œæ¥µä½ã€

---

## 5. é©—è­‰æŒ‡æ¨™

### 5.1 é‡åŒ–æŒ‡æ¨™

| æŒ‡æ¨™ | æ”¹å–„å‰ï¼ˆé ä¼°ï¼‰ | æ”¹å–„å¾Œï¼ˆç›®æ¨™ï¼‰ |
|------|---------------|---------------|
| èƒŒæ™¯å–šé†’æ¬¡æ•¸ï¼ˆ30 åˆ†é˜ï¼‰ | 10-20 æ¬¡ | 0-2 æ¬¡ |
| èƒŒæ™¯æ´»å‹•æ™‚é–“ï¼ˆ30 åˆ†é˜ï¼‰ | 30-60 ç§’ | < 5 ç§’ |
| è¨˜æ†¶é«”ä½”ç”¨ï¼ˆèƒŒæ™¯ï¼‰ | 50-80 MB | 30-50 MB |
| CPU ä½¿ç”¨ç‡ï¼ˆèƒŒæ™¯ï¼‰ | 5-10% | < 1% |
| é›»æ± è€—é›»ï¼ˆ1 å°æ™‚èƒŒæ™¯ï¼‰ | 1-2% | < 0.3% |

---

### 5.2 è³ªåŒ–æŒ‡æ¨™

| é …ç›® | æ”¹å–„å‰ | æ”¹å–„å¾Œ |
|------|-------|-------|
| iOS é›»æ± ç®¡ç†é¡¯ç¤º | âš ï¸ é¡¯ç¤ºã€Œé«˜èƒŒæ™¯æ´»å‹•ã€ | âœ… é¡¯ç¤ºæ­£å¸¸ |
| Xcode Instruments Energy | âš ï¸ é»ƒè‰²/ç´…è‰²è­¦å‘Š | âœ… ç¶ è‰²/ç„¡è­¦å‘Š |
| ç”¨æˆ¶åé¥‹ | âš ï¸ æŠ±æ€¨è€—é›» | âœ… ç„¡è€—é›»æŠ±æ€¨ |

---

## 6. ç¨‹å¼ç¢¼è®Šæ›´æª¢æŸ¥æ¸…å–®

### 6.1 å¿…é ˆä¿®æ”¹çš„æª”æ¡ˆï¼ˆP0ï¼‰âœ… å·²å®Œæˆ

- [x] **StatisticsViewModel.swift**
  - [x] æ–°å¢ `clearTipWorkItem` èˆ‡ `cancelPendingTasks()`
  - [x] ä¿®æ”¹ `clearTipAfterDelay()` ä½¿ç”¨å¯å–æ¶ˆä»»å‹™
  - [x] æ–°å¢ `deinit` ç¢ºä¿æ¸…ç†

- [x] **ChargedLogViewModel.swift**
  - [x] æ–°å¢ `currentTask` èˆ‡ `cancelPendingRequests()`
  - [x] ä¿®æ”¹ `loadLogs()` å„²å­˜ task ä¸¦æ”¯æ´å–æ¶ˆ
  - [x] èª¿æ•´ `minRefreshInterval` å¾ 600 æ”¹ç‚º 1800ï¼ˆ30 åˆ†é˜ï¼‰
  - [x] æ–°å¢ `deinit` ç¢ºä¿æ¸…ç†

- [x] **ChargedLogService.swift**
  - [x] ä¿®æ”¹ `fetchChargedLogs()` å›å‚³ `URLSessionDataTask?`
  - [x] ä¿®æ”¹ `fetchStatistics()` å›å‚³ `URLSessionDataTask?`

- [x] **ContentView.swift**
  - [x] ä¿®æ”¹ `@ObservedObject` ç‚º `@StateObject`
  - [x] åŠ å¼· `onChange(of: scenePhase)` è™•ç†
  - [x] ä¿®æ”¹ `DatePickerSheet` ç§»é™¤ `asyncAfter`

---

### 6.2 å»ºè­°ä¿®æ”¹çš„æª”æ¡ˆï¼ˆP1ï¼‰

- [ ] **ChargedLogService.swift**
  - [ ] æ–°å¢ `urlSession` è‡ªè¨‚é…ç½®

- [ ] **StatisticsViewModel.swift**
  - [ ] æ–°å¢ `pauseSubscriptions()` / `resumeSubscriptions()`
  - [ ] ä¿®æ”¹ `.sink` è¨‚é–±åŠ å…¥ `isSubscriptionActive` æª¢æŸ¥

- [ ] **ChargedLogViewModel.swift**
  - [ ] èª¿æ•´ `minRefreshInterval` å¾ 600 æ”¹ç‚º 1800

---

### 6.3 å¯é¸ä¿®æ”¹çš„æª”æ¡ˆï¼ˆP2ï¼‰

- [ ] **AppTheme.swift**
  - [ ] æ–°å¢ `saveWorkItem` èˆ‡ `saveImmediately()`
  - [ ] ä¿®æ”¹ `didSet` å»¶é²å„²å­˜

- [ ] **NetworkMonitor.swift**ï¼ˆæ–°å»ºï¼‰
  - [ ] å¯¦ä½œç¶²è·¯ç‹€æ…‹ç›£æ§

- [ ] **BackgroundActivityLogger.swift**ï¼ˆæ–°å»ºï¼‰
  - [ ] å¯¦ä½œ Debug æ—¥èªŒå·¥å…·

---

## 7. ç›¸é—œè³‡æº

### 7.1 Apple å®˜æ–¹æ–‡ä»¶
- [Energy Efficiency Guide for iOS Apps](https://developer.apple.com/library/archive/documentation/Performance/Conceptual/EnergyGuide-iOS/)
- [URLSession Background Downloads](https://developer.apple.com/documentation/foundation/url_loading_system/downloading_files_in_the_background)
- [Managing Your App's Life Cycle](https://developer.apple.com/documentation/uikit/app_and_environment/managing_your_app_s_life_cycle)

### 7.2 Best Practices
- **é¿å…èƒŒæ™¯å–šé†’**ï¼šé€²å…¥èƒŒæ™¯æ™‚å–æ¶ˆæ‰€æœ‰å»¶é²ä»»å‹™èˆ‡ç¶²è·¯è«‹æ±‚
- **ViewModel ç”Ÿå‘½é€±æœŸ**ï¼šä½¿ç”¨ `@StateObject` è€Œé `@ObservedObject`
- **è¨˜æ†¶é«”ç®¡ç†**ï¼šç¢ºä¿ `deinit` è¢«å‘¼å«ï¼Œæ¸…ç†è¨‚é–±èˆ‡è³‡æº
- **ç¶²è·¯è«‹æ±‚**ï¼šæ°¸é æä¾›å–æ¶ˆæ©Ÿåˆ¶ï¼Œé¿å…èƒŒæ™¯åŸ·è¡Œ

### 7.3 æ¸¬è©¦å·¥å…·
- **Xcode Instruments**ï¼šEnergy Logã€Time Profilerã€Leaks
- **iOS è¨­å®š**ï¼šé›»æ±  > é¡¯ç¤ºæ´»å‹•
- **Console.app**ï¼šå³æ™‚æŸ¥çœ‹ç³»çµ±æ—¥èªŒ

---

## 8. é¢¨éšªè©•ä¼°

| é¢¨éšª | æ©Ÿç‡ | å½±éŸ¿ | ç·©è§£æªæ–½ |
|------|------|------|---------|
| æ”¹å–„å¾Œåˆ·æ–°å¤±æ•— | ä½ | ä¸­ | åŠ å…¥å–®å…ƒæ¸¬è©¦é©—è­‰ `refreshIfNeeded` é‚è¼¯ |
| ViewModel è¨˜æ†¶é«”æ´©æ¼ | ä½ | é«˜ | ä½¿ç”¨ Instruments Leaks å·¥å…·é©—è­‰ |
| ç¶²è·¯è«‹æ±‚å–æ¶ˆéæ—© | ä¸­ | ä½ | åƒ…åœ¨ `.background` å–æ¶ˆï¼Œ`.inactive` ä¸å–æ¶ˆ |
| UserDefaults å¯«å…¥å¤±æ•— | æ¥µä½ | ä½ | ä½¿ç”¨ `UserDefaults.standard.synchronize()` |

---

## 9. ç‰ˆæœ¬æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | èªªæ˜ |
|------|------|------|
| 1.0 | 2026-02-01 | åˆç‰ˆè¦æ ¼æ›¸ï¼Œå®šç¾© P0/P1/P2 æ”¹å–„æ–¹æ¡ˆ |
| 1.1 | 2026-02-01 | P0 æ”¹å–„æ–¹æ¡ˆå¯¦ä½œå®Œæˆ |

---

## 10. é™„éŒ„ï¼šå¿«é€Ÿåƒè€ƒ

### å®Œæ•´çš„ ContentView scenePhase è™•ç†

```swift
.onChange(of: scenePhase) { newPhase in
    BackgroundActivityLogger.shared.log("Scene phase changed to: \(newPhase)")
    
    switch newPhase {
    case .active:
        // â˜€ï¸ é€²å…¥å‰æ™¯
        BackgroundActivityLogger.shared.log("â˜€ï¸ Entering foreground")
        statisticsViewModel.resumeSubscriptions()
        viewModel.refreshIfNeeded()
        statisticsViewModel.loadStatistics()
        
    case .background:
        // ğŸŒ™ é€²å…¥èƒŒæ™¯
        BackgroundActivityLogger.shared.log("ğŸŒ™ Entering background")
        
        // 1. å–æ¶ˆå»¶é²ä»»å‹™
        statisticsViewModel.cancelPendingTasks()
        
        // 2. æš«åœè¨‚é–±
        statisticsViewModel.pauseSubscriptions()
        
        // 3. å–æ¶ˆç¶²è·¯è«‹æ±‚
        viewModel.cancelPendingRequests()
        
        // 4. ç«‹å³å„²å­˜è¨­å®š
        theme.saveImmediately()
        
    case .inactive:
        // â¸ï¸ çŸ­æš«ä¸æ´»èºï¼ˆä¾†é›»ã€é€šçŸ¥ç­‰ï¼‰
        BackgroundActivityLogger.shared.log("â¸ï¸ Inactive")
        // ä¸åŸ·è¡Œæ¸…ç†å‹•ä½œï¼Œé¿å…å½±éŸ¿ç”¨æˆ¶é«”é©—
        
    @unknown default:
        break
    }
}
```

---

**æ–‡ä»¶ç¶­è­·è€…**ï¼šGitHub Copilot  
**æœ€å¾Œæ›´æ–°**ï¼š2026-02-01  
**å¯©æ ¸ç‹€æ…‹**ï¼šâœ… å¾…æŠ€è¡“å¯©æ ¸èˆ‡å¯¦ä½œ
