# 手動新增充電紀錄 功能規格書

## 1. 功能概述
允許用戶於 App 內手動新增充電紀錄，透過 Google Apps Script API 將資料寫入 Google Sheets。

## 2. UI 設計

### 2.1 入口
- **位置**：充電紀錄列表頁面右下角
- **元件**：浮動按鈕（FAB, Floating Action Button）
- **圖示**：`+` 號 ICON
- **樣式**：圓形按鈕，符合 Tesla 官方設計風格，支援深色模式

### 2.2 新增紀錄表單（Sheet / Modal）
點擊 `+` 按鈕後，彈出表單頁面或 Modal，包含以下欄位：

| 欄位名稱 | 類型 | 必填 | 說明 |
|---------|------|------|------|
| 價格 / kWh | 數字輸入 + 下拉選單 | ✅ | 支援手動輸入小數點，或從常用價格下拉選擇 |
| 充電類型 | 下拉選單 | ✅ | 選項：`ACSingleWireCAN`、`Supercharger`、`J1772`<br>預設值：`ACSingleWireCAN` |

### 2.3 常用價格下拉選項
```
預設選項：
- 2.5
- 3.0
- 3.5
- 4.0
- 7.0（超充參考價）
- 自訂輸入

用戶自訂選項：
- （動態新增，由用戶歷史輸入產生）
```

**自動記錄功能**：
- 當用戶手動輸入自訂價格並成功送出後，系統自動將該價格加入常用價格下拉選項
- 儲存於本地（UserDefaults），App 重啟後仍保留
- 自訂價格按數值由小到大排序，顯示於預設選項下方
- 重複價格不會重複加入
- 最多保留 10 筆自訂價格（超過時移除最舊的）

### 2.4 按鈕
- **送出按鈕**：驗證通過後送出 API 請求
- **取消按鈕**：關閉表單，不送出

## 3. 欄位驗證規則

| 欄位 | 驗證規則 |
|------|---------|
| 價格 / kWh | 必填、須為正數、支援小數點（最多 2 位） |
| 充電類型 | 必填、須為指定選項之一 |

## 4. API 串接

### 4.1 Endpoint
```
POST https://script.google.com/macros/s/AKfycbzQ8eh0akIWnsk1XOuYippDln5usy2_CKobrZyH9AN6k8j9cbAicHGroNspBOTWQwt-/exec
```

### 4.2 Request Body (JSON)

| 參數 | 對應欄位 | 範例 |
|------|---------|------|
| `price` | 價格 / kWh | `3.1` |
| `type` | 充電類型 | `"ACSingleWireCAN"` |
| `method` | 請求方法 | `"POST"` |

### 4.3 請求範例
```bash
curl --location 'https://script.google.com/macros/s/AKfycbzQ8eh0akIWnsk1XOuYippDln5usy2_CKobrZyH9AN6k8j9cbAicHGroNspBOTWQwt-/exec' \
  --header 'Content-Type: text/plain;charset=utf-8' \
  --data '{"price": 3.1, "type": "ACSingleWireCAN", "method": "POST"}'
```

### 4.4 回應格式
```json
{
    "status": "success" | "error",
    "code": 200 | 400 | ...,
    "data": { ... },
    "message": "訊息內容"
}
```

### 4.5 回應處理邏輯

```swift
// Swift 虛擬碼
if response.status == "success" {
    // ✅ 成功邏輯
    // 1. 顯示成功提示：response.message
    // 2. 關閉表單
    // 3. 重新載入充電紀錄列表
} else {
    // ❌ 失敗邏輯
    // 1. 顯示錯誤提示：response.message
    // 2. 保留表單內容，讓用戶可修改後重試
}
```

## 5. 使用者流程（User Flow）

```
┌─────────────────────────────────────────────────────────────┐
│                    充電紀錄列表頁面                           │
│                                                             │
│   ┌──────────────────────────────────────────────────────┐  │
│   │  紀錄 1                                              │  │
│   │  紀錄 2                                              │  │
│   │  紀錄 3                                              │  │
│   │  ...                                                 │  │
│   └──────────────────────────────────────────────────────┘  │
│                                                             │
│                                              ┌─────┐        │
│                                              │  +  │ ◄── FAB│
│                                              └─────┘        │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼ 點擊 +
┌─────────────────────────────────────────────────────────────┐
│                    新增充電紀錄                              │
│                                                             │
│   價格 / kWh                                                │
│   ┌────────────────────────────────────────┐                │
│   │  3.1                              ▼    │ ◄── 可輸入/下拉 │
│   └────────────────────────────────────────┘                │
│                                                             │
│   充電類型                                                   │
│   ┌────────────────────────────────────────┐                │
│   │  ACSingleWireCAN                  ▼    │ ◄── 下拉選單   │
│   └────────────────────────────────────────┘                │
│                                                             │
│   ┌────────────┐    ┌────────────┐                          │
│   │   取消     │    │   送出     │                          │
│   └────────────┘    └────────────┘                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼ 點擊送出
                    ┌──────────────┐
                    │  呼叫 API    │
                    └──────────────┘
                           │
              ┌────────────┴────────────┐
              ▼                         ▼
      ┌──────────────┐          ┌──────────────┐
      │  ✅ 成功     │          │  ❌ 失敗     │
      │  顯示提示    │          │  顯示錯誤    │
      │  關閉表單    │          │  保留表單    │
      │  重載列表    │          │  可重試      │
      └──────────────┘          └──────────────┘
```

## 6. 技術實作建議

### 6.1 新增檔案
- `AddChargeRecordView.swift`：新增充電紀錄表單 View
- `AddChargeRecordViewModel.swift`：處理表單邏輯與 API 呼叫
- `CustomPriceManager.swift`：管理自訂價格的儲存與讀取

### 6.2 修改檔案
- `ContentView.swift`：加入 FAB 按鈕與導航邏輯
- `ChargedLogService.swift`：新增 API 呼叫方法

### 6.3 資料模型

```swift
// 充電類型列舉
enum ChargeType: String, CaseIterable {
    case acSingleWireCAN = "ACSingleWireCAN"
    case supercharger = "Supercharger"
    case j1772 = "J1772"
    
    var displayName: String {
        switch self {
        case .acSingleWireCAN: return "AC"
        case .supercharger: return "DC (Supercharger)"
        case .j1772: return "J1772"
        }
    }
}

// API 回應模型
struct AddChargeRecordResponse: Codable {
    let status: String
    let code: Int
    let data: [String: AnyCodable]?
    let message: String
    
    var isSuccess: Bool {
        return status == "success"
    }
}
```

### 6.4 API 呼叫範例

```swift
func addChargeRecord(price: Double, type: ChargeType) async throws -> AddChargeRecordResponse {
    guard let url = URL(string: "https://script.google.com/macros/s/AKfycbzQ8eh0akIWnsk1XOuYippDln5usy2_CKobrZyH9AN6k8j9cbAicHGroNspBOTWQwt-/exec") else {
        throw URLError(.badURL)
    }
    
    // 建立 POST 請求
    var request = URLRequest(url: url)
    request.httpMethod = "POST"
    request.setValue("text/plain;charset=utf-8", forHTTPHeaderField: "Content-Type")
    
    // 建立 JSON body
    let body: [String: Any] = [
        "price": price,
        "type": type.rawValue,
        "method": "POST"
    ]
    request.httpBody = try JSONSerialization.data(withJSONObject: body)
    
    let (data, _) = try await URLSession.shared.data(for: request)
    return try JSONDecoder().decode(AddChargeRecordResponse.self, from: data)
}
```

### 6.5 自訂價格儲存管理

```swift
class CustomPriceManager {
    private static let key = "customChargePrice"
    private static let maxCount = 10
    
    /// 取得所有自訂價格（已排序）
    static func getCustomPrices() -> [Double] {
        let prices = UserDefaults.standard.array(forKey: key) as? [Double] ?? []
        return prices.sorted()
    }
    
    /// 新增自訂價格
    static func addCustomPrice(_ price: Double) {
        var prices = UserDefaults.standard.array(forKey: key) as? [Double] ?? []
        
        // 檢查是否已存在（避免重複）
        if prices.contains(price) { return }
        
        // 新增價格
        prices.append(price)
        
        // 超過上限時移除最舊的
        if prices.count > maxCount {
            prices.removeFirst()
        }
        
        UserDefaults.standard.set(prices, forKey: key)
    }
    
    /// 取得完整價格選項（預設 + 自訂）
    static func getAllPriceOptions() -> [Double] {
        let defaultPrices: [Double] = [2.5, 3.0, 3.5, 4.0, 7.0]
        let customPrices = getCustomPrices()
        
        // 合併並去重，排序
        return Array(Set(defaultPrices + customPrices)).sorted()
    }
}
```

## 7. 錯誤處理

| 情境 | 處理方式 |
|------|---------|
| 網路錯誤 | 顯示「網路連線失敗，請檢查網路後重試」 |
| API 回傳 error | 顯示 API 回傳的 `message` |
| 欄位驗證失敗 | 於對應欄位下方顯示紅色錯誤提示 |
| 超時 | 顯示「請求超時，請稍後重試」 |

## 8. UI/UX 注意事項
- 送出按鈕在請求中應顯示 Loading 狀態，並禁用重複點擊
- 支援深色模式
- 鍵盤彈出時，表單應自動調整避免被遮擋
- 價格輸入欄位應限制為數字鍵盤（支援小數點）

## 9. 測試案例

| 測試項目 | 預期結果 |
|---------|---------|
| 點擊 + 按鈕 | 開啟新增充電紀錄表單 |
| 未填寫價格，點擊送出 | 顯示必填錯誤提示 |
| 輸入負數價格 | 顯示驗證錯誤 |
| 正確填寫並送出 | 呼叫 API，依回應顯示成功/失敗 |
| API 回傳 success | 關閉表單、重載列表、顯示成功訊息 |
| API 回傳 error | 顯示錯誤訊息、保留表單 |
| 點擊取消 | 關閉表單，不送出 |
| 輸入自訂價格並成功送出 | 該價格自動加入下拉選項 |
| 重複輸入相同自訂價格 | 不會重複加入下拉選項 |
| 自訂價格超過 10 筆 | 最舊的自訂價格被移除 |
| App 重啟後開啟表單 | 自訂價格仍保留於下拉選項 |

---

## 10. 相關文件
- [PRD.md](../PRD.md)：產品主要規格書
- [ChargedLogExample.json](../example/ChargedLogExample.json)：充電紀錄資料範例
